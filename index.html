<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Messaging App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="icon.jpg" type="image/icon type">    


  <!-- <script src="firebase-messaging-sw.js" defer></script> -->
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div id="container">
    <div id="login">
      <h2>Login</h2>
      <button id="loginGoogleBtn">Login with Google</button>
      <form id="loginForm" style="margin-top: 20px; display: none;">
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passwordInput" placeholder="Password">
        <button type="submit">Login with Email</button>
      </form>
    </div>
    <form id="signupForm" style="display: none;">
      <input type="email" id="signupEmail" placeholder="Email" required>
      <input type="password" id="signupPassword" placeholder="Password" required>
      <button type="submit">Sign Up</button>
    </form>
    <div id="profileForm" style="display:none;">
      <h2>Profile Setup</h2>
      <input type="file" id="photoInput" accept="image/*" style="margin-bottom: 10px;">
      <input type="text" id="displayNameInput" placeholder="Display Name" style="margin-bottom: 10px;">
      <textarea id="descriptionInput" placeholder="Description" style="margin-bottom: 10px;"></textarea>
      <button id="saveProfileBtn">Save Profile</button>
    </div>
    <div id="chat" style="display:none;">
        <header>
            <div>
              <div id="userProfile"></div>
              <div id="statusMessage" style="display: none; color: red; text-align: center; margin-top: 10px;"></div>
            </div>
            <div>
                <button id="logoutBtn">Logout</button>
                <button id="enableNotificationsBtn">ðŸ””</button>
            </div>
        </header>
      <div id="messages"></div>
      <form id="messageForm">
        <input type="text" id="messageInput" autocomplete="off" placeholder="Type a message...">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
// Fonction pour dÃ©filer jusqu'en bas de la page
function scrollToBottom() {
    // Obtenir la hauteur totale de la page
    var pageHeight = document.documentElement.scrollHeight;

    // Faire dÃ©filer jusqu'en bas de la page
    window.scrollTo(0, pageHeight);
}

setTimeout(function() {
  scrollToBottom();
}, 1000)
// Appeler la fonction pour dÃ©filer jusqu'en bas
});
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiSV10-EsyFSCYE3sqH4fyDSib_K1IslM",
      authDomain: "messagerie-c13c9.firebaseapp.com",
      projectId: "messagerie-c13c9",
      storageBucket: "messagerie-c13c9.appspot.com",
      messagingSenderId: "33075375209",
      appId: "1:33075375209:web:90944619955684bf6286f8",
      measurementId: "G-W87XEXNC4L"
    };



    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const messaging = getMessaging(app);
    const firestore = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const container = document.getElementById('container');
    const login = document.getElementById('login');
    const profileForm = document.getElementById('profileForm');
    const chat = document.getElementById('chat');
    const userProfile = document.getElementById('userProfile');
    const loginGoogleBtn = document.getElementById('loginGoogleBtn');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const logoutBtn = document.getElementById('logoutBtn');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messagesDiv = document.getElementById('messages');
    const photoInput = document.getElementById('photoInput');
    const displayNameInput = document.getElementById('displayNameInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    let currentUser = null;

    loginGoogleBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("Error during sign in with Google:", error);
      }
    });



      // Gestionnaire d'Ã©vÃ©nement pour le formulaire d'inscription
//   signupForm.addEventListener('submit', async (e) => {
//     e.preventDefault();
//     const email = document.getElementById('signupEmail').value;
//     const password = document.getElementById('signupPassword').value;
//     try {
//       const userCredential = await createUserWithEmailAndPassword(auth, email, password);
//       // Inscription rÃ©ussie, vous pouvez rediriger l'utilisateur vers une page de connexion ou effectuer d'autres actions nÃ©cessaires.
//     } catch (error) {
//       console.error("Error during sign up:", error);
//       // GÃ©rer l'erreur d'inscription ici
//     }
//   });
//     // Login with email and password
//     loginForm.addEventListener('submit', async (e) => {
//       e.preventDefault();
//       const email = emailInput.value;
//       const password = passwordInput.value;
//       try {
//         await signInWithEmailAndPassword(auth, email, password);
//       } catch (error) {
//         console.error("Error during sign in with email:", error);
//       }
//     });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    login.style.display = 'none';
    
    if (user.displayName) {
      profileForm.style.display = 'none';
      chat.style.display = 'flex';
      loadMessages();
    } else {
      profileForm.style.display = 'block';
      chat.style.display = 'none';
      container.style.background = 'none';
    }
    userProfile.textContent = `Logged in as: ${user.displayName || 'Unknown'}`;

  } else {
    currentUser = null;
    login.style.display = 'flex';
    profileForm.style.display = 'none';
    chat.style.display = 'none';
    container.style.background = 'none';
  }
});





saveProfileBtn.addEventListener('click', async () => {
  const displayName = displayNameInput.value.trim();
  const description = descriptionInput.value.trim();
  const file = photoInput.files[0]; // RÃ©cupÃ¨re le fichier de la photo de profil

  try {
    let photoURL = null;
    if (file) {
      // TÃ©lÃ©charger la photo de profil sur le stockage Firebase
      const storageRef = ref(storage, `profilePictures/${currentUser.uid}/${file.name}`);
      const snapshot = await uploadBytes(storageRef, file);
      photoURL = await getDownloadURL(snapshot.ref);
    }

    if (!currentUser.providerData.some(provider => provider.providerId === 'google.com')) {
      // Si l'utilisateur n'est pas connectÃ© avec Google, mettre Ã  jour le nom d'affichage
      await updateProfile(auth.currentUser, { displayName: displayName });
    }

    // Mettre Ã  jour les autres informations du profil avec la photo de profil si disponible
    await updateProfile(auth.currentUser, {
      displayName: displayName,
      photoURL: photoURL,
    });

    // Enregistrer les autres informations dans la base de donnÃ©es
    await addDoc(collection(firestore, 'users'), {
      uid: currentUser.uid,
      displayName: displayName,
      description: description,
      photoURL: photoURL,
    });
  } catch (error) {
    console.error("Error updating profile:", error);
  }
});



// Envoyer un message
messageForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  console.log('user', currentUser)
  console.log("displayName:", currentUser.displayName);
  console.log("photoURL:", currentUser.photoURL);
  
  const messageText = messageInput.value.trim();
  if (messageText && currentUser.displayName && currentUser.photoURL) {
    await addDoc(collection(firestore, 'messages'), {
      text: messageText,
      createdAt: serverTimestamp(),
      uid: auth.currentUser.uid,
      displayName: currentUser.displayName,
      photoURL: currentUser.photoURL
    });
    messageInput.value = '';
  } else {
    alert("Please set up your profile before sending messages.");
    profileForm.style.display = "block";
  }
});


    // Charger les messages
// Charger les messages
const loadMessages = () => {
  const q = query(collection(firestore, 'messages'), orderBy('createdAt'));
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = '';
    snapshot.forEach((doc) => {
      const message = doc.data();
      const messageElement = document.createElement('div');
      messageElement.innerHTML = `
        <img src="${message.photoURL || 'placeholder.jpg'}" alt="Profile Picture" 
             style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
        <strong>${message.displayName || 'Unknown User'}:</strong> ${message.text}`;
      messagesDiv.appendChild(messageElement);
    });
  });
};


// VÃ©rifier la connexion rÃ©seau
function isOnline() {
  return navigator.onLine;
}

// Enregistrer les messages en attente dans le localStorage
function savePendingMessage(message) {
  let pendingMessages = JSON.parse(localStorage.getItem('pendingMessages')) || [];
  if (pendingMessages.length < 3) {
    pendingMessages.push(message);
    localStorage.setItem('pendingMessages', JSON.stringify(pendingMessages));
    return true;
  } else {
    alert("Vous ne pouvez envoyer que 3 messages hors connexion.");
    return false;
  }
}

// Envoyer les messages en attente dÃ¨s que la connexion est rÃ©tablie
function sendPendingMessages() {
  let pendingMessages = JSON.parse(localStorage.getItem('pendingMessages')) || [];
  if (pendingMessages.length > 0) {
    pendingMessages.forEach(async (message) => {
      await addDoc(collection(firestore, 'messages'), message);
    });
    localStorage.removeItem('pendingMessages');
  }
}

// VÃ©rifier la connexion rÃ©seau au chargement de la page
window.addEventListener('load', () => {
  if (isOnline()) {
    sendPendingMessages();
  }
});

// Envoyer les messages en attente lorsqu'on passe hors ligne Ã  en ligne
window.addEventListener('online', () => {
  sendPendingMessages();
});

// Envoyer un message
messageForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const messageText = messageInput.value.trim();
  if (messageText && currentUser.displayName && currentUser.photoURL) {
    const message = {
      text: messageText,
      createdAt: serverTimestamp(),
      uid: auth.currentUser.uid,
      displayName: currentUser.displayName,
      photoURL: currentUser.photoURL
    };
    
    if (isOnline()) {
      await addDoc(collection(firestore, 'messages'), message);
    } else {
      if (savePendingMessage(message)) {
        alert("Vous Ãªtes hors connexion. Votre message sera envoyÃ© lorsque la connexion sera rÃ©tablie.");
      }
    }
    
    messageInput.value = '';
  } else {
    alert("Please set up your profile before sending messages.");
    profileForm.style.display = "block";
  }
});



const statusMessage = document.getElementById('statusMessage');

window.addEventListener('online', () => {
  statusMessage.style.display = 'none';
  sendPendingMessages();
});

window.addEventListener('offline', () => {
  statusMessage.textContent = 'Vous Ãªtes hors connexion. Les messages envoyÃ©s seront mis en attente.';
  statusMessage.style.display = 'block';
});

messageForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const messageText = messageInput.value.trim();
  if (messageText && currentUser.displayName && currentUser.photoURL) {
    const message = {
      text: messageText,
      createdAt: serverTimestamp(),
      uid: auth.currentUser.uid,
      displayName: currentUser.displayName,
      photoURL: currentUser.photoURL
    };

    if (isOnline()) {
      await addDoc(collection(firestore, 'messages'), message);
    } else {
      if (savePendingMessage(message)) {
        alert("Vous Ãªtes hors connexion. Votre message sera envoyÃ© lorsque la connexion sera rÃ©tablie.");
        statusMessage.textContent = 'Vous Ãªtes hors connexion. Les messages envoyÃ©s seront mis en attente.';
        statusMessage.style.display = 'block';
      }
    }

    messageInput.value = '';
  } else {
    alert("Please set up your profile before sending messages.");
    profileForm.style.display = "block";
  }
});


const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');

enableNotificationsBtn.addEventListener('click', async () => {
  try {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      const messaging = getMessaging(app);
      const token = await getToken(messaging, { vapidKey: 'YOUR_PUBLIC_VAPID_KEY' });
      console.log('Notification token:', token);
      // Vous pouvez envoyer ce token Ã  votre serveur pour enregistrer cet utilisateur pour des notifications push
      alert('Notifications enabled!');
    } else {
      alert('Notifications permission denied');
    }
  } catch (error) {
    console.error('Error enabling notifications:', error);
  }
});



setTimeout(function() {
  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then((registration) => {
      console.log('Service Worker registered with scope:', registration.scope);
    })
    .catch((error) => {
      console.log('Service Worker registration failed:', error);
    });
}

},10000);



  </script>
</body>
</html>
